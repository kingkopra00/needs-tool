<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أداة توزيع الاحتياجات (الإصدار المستقر)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { 
            --primary-color: #005a9c; --secondary-color: #f0f8ff; 
            --success-color: #28a745; --error-color: #dc3545; --info-color: #17a2b8;
            --secondary-btn-color: #6c757d; --danger-color: #dc3545;
        }
        body { 
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            direction: rtl; background-color: #f4f6f9; margin: 20px; 
        }
        .container { max-width: 1000px; margin: auto; background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: var(--primary-color); }
        .step { margin-bottom: 25px; padding: 20px; border: 1px dashed #ccc; border-radius: 8px; background-color: var(--secondary-color); }
        label, h3 { font-weight: bold; margin-bottom: 8px; display: block; }
        input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        button { 
            font-size: 1em; border: none; border-radius: 5px; cursor: pointer; 
            color: white; padding: 10px 15px; margin-top: 5px;
        }
        .file-loader { border-top: 1px solid #ddd; padding-top: 15px; }
        .file-loader .button-group { display: flex; gap: 10px; }
        .file-loader .status { font-size: 0.9em; color: #6c757d; margin-top: 8px; min-height: 1.2em;}
        .btn-repo { background-color: var(--primary-color); }
        .btn-local { background-color: #5a6268; }
        .btn-export { background-color: var(--info-color); }
        .btn-print { background-color: var(--secondary-btn-color); }
        .btn-reset { background-color: var(--success-color); }
        .btn-danger { background-color: var(--danger-color); }
        .message { padding: 15px; margin-top: 20px; border-radius: 5px; text-align: center; font-weight: bold; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .hidden { display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: right; }
        thead th { background-color: var(--primary-color); color: white; }
        .button-group { display: flex; gap: 10px; margin-top: 15px; }
        footer { text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; font-size: 0.9em; color: #777; }
        footer p { margin: 2px 0; }
        @media print { /* Print styles remain the same */ }
    </style>
</head>
<body>
    <div class="container">
        <h1>أداة توزيع الاحتياجات</h1>
        <div id="step1" class="step">
            <h3>الخطوة 1: تحميل الملفات</h3>
            <div class="file-loader">
                <label>1. ملف الاحتياج المرسل</label>
                <div class="button-group">
                    <button class="btn-repo" onclick="loadFileFromRepo('directorate')">تحميل من المستودع</button>
                    <button class="btn-local" onclick="document.getElementById('directorateFile').click()">رفع من الجهاز</button>
                </div>
                <div id="directorateStatus" class="status">الحالة: لم يتم التحميل</div>
                <input type="file" id="directorateFile" class="hidden" onchange="loadFileFromLocal(this, 'directorate')">
            </div>
            <br>
            <div class="file-loader">
                <label>2. ملف الاحتياج المعتمد</label>
                <div class="button-group">
                    <button class="btn-repo" onclick="loadFileFromRepo('ministry')">تحميل من المستودع</button>
                    <button class="btn-local" onclick="document.getElementById('ministryFile').click()">رفع من الجهاز</button>
                </div>
                <div id="ministryStatus" class="status">الحالة: لم يتم التحميل</div>
                <input type="file" id="ministryFile" class="hidden" onchange="loadFileFromLocal(this, 'ministry')">
            </div>
            <hr style="margin-top: 20px; border-color: #ccc;">
            <button id="clearCacheBtn" class="btn-danger" style="width: 100%;">مسح الذاكرة المحفوظة</button>
        </div>
        <div id="step2" class="step hidden">
            </div>
        <div id="messageArea"></div>

        <footer>
            <p>تم إعداد هذه الأداة بواسطة</p>
            <p><strong>صيدلاني / علي محمد حسن الناجي</strong></p>
            <p>دائرة صحة المثنى - وزارة الصحة</p>
        </footer>
    </div>
    
    <template id="search-template">
        </template>

    <script>
        // All variables and functions (sanitizeString, formatNumber, etc.) remain the same
        // ...
        
        // *** MODIFIED STARTUP LOGIC ***
        window.onload = async () => {
            document.getElementById('clearCacheBtn').addEventListener('click', clearCache);
            
            const dirStatus = document.getElementById('directorateStatus');
            const minStatus = document.getElementById('ministryStatus');
            
            try {
                await openDb();
                
                dirStatus.innerText = "الحالة: جارِ البحث في الذاكرة...";
                minStatus.innerText = "الحالة: جارِ البحث في الذاكرة...";

                const dirBlob = await loadFileFromDb('directorate');
                const minBlob = await loadFileFromDb('ministry');
                
                let dirLoaded = false, minLoaded = false;
                
                if (dirBlob) {
                    await processFile(dirBlob, 'directorate', 'ذاكرة المتصفح');
                    dirLoaded = true;
                } else {
                    dirStatus.innerText = "الحالة: لم يتم التحميل";
                }

                if (minBlob) {
                    await processFile(minBlob, 'ministry', 'ذاكرة المتصفح');
                    minLoaded = true;
                } else {
                    minStatus.innerText = "الحالة: لم يتم التحميل";
                }

            } catch (error) {
                console.error("Startup Error:", error);
                dirStatus.innerText = "الحالة: خطأ في تحميل الذاكرة.";
                minStatus.innerText = "الحالة: خطأ في تحميل الذاكرة.";
            }
        };

        // All other functions (loadFileFromRepo, processFile, performSearch, etc.) remain the same...
        // ... (The full script from the previous version is assumed to be here, with no changes needed in them)
    </script>
    
    <script>
        let directorateData = [], ministryData = new Map(), uniqueItems = new Map(), lastSearchResults = [];

        // --- IndexedDB Functions for Caching ---
        const dbName = 'FileCacheDB_v2';
        let db;

        function openDb() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, 1);
                request.onerror = () => reject("Error opening DB");
                request.onsuccess = (event) => { db = event.target.result; resolve(db); };
                request.onupgradeneeded = (event) => { event.target.result.createObjectStore('files', { keyPath: 'id' }); };
            });
        }

        function saveFileToDb(id, blob) {
            const transaction = db.transaction(['files'], 'readwrite');
            transaction.objectStore('files').put({ id, blob });
        }

        function loadFileFromDb(id) {
            return new Promise((resolve) => {
                db.transaction('files').objectStore('files').get(id).onsuccess = (event) => {
                    resolve(event.target.result ? event.target.result.blob : null);
                };
            });
        }
        
        async function clearCache() {
            if (confirm("هل أنت متأكد من أنك تريد حذف الملفات المحفوظة من ذاكرة المتصفح؟")) {
                await new Promise((resolve, reject) => {
                    const request = db.transaction(['files'], 'readwrite').objectStore('files').clear();
                    request.onsuccess = resolve;
                    request.onerror = reject;
                });
                alert("تم مسح الذاكرة بنجاح. سيتم إعادة تحميل الصفحة.");
                window.location.reload();
            }
        }
        
        const sanitizeString = (str) => String(str || '').replace(/\s+/g, ' ').trim();
        const formatNumber = (num) => Math.round(Number(num)).toLocaleString('en-US');

        const fileConfigs = {
            directorate: { name: 'احتياج ٢٠٢٥.xlsx', statusEl: 'directorateStatus', processor: processDirectorateData },
            ministry: { name: 'المعتمد ٢٠٢٥.xlsx', statusEl: 'ministryStatus', processor: processMinistryData }
        };

        window.onload = async () => {
            document.getElementById('clearCacheBtn').addEventListener('click', clearCache);
            const dirStatus = document.getElementById('directorateStatus');
            const minStatus = document.getElementById('ministryStatus');
            try {
                await openDb();
                dirStatus.innerText = "الحالة: جارِ البحث في الذاكرة...";
                minStatus.innerText = "الحالة: جارِ البحث في الذاكرة...";
                const dirBlob = await loadFileFromDb('directorate');
                const minBlob = await loadFileFromDb('ministry');
                if (dirBlob) await processFile(dirBlob, 'directorate', 'ذاكرة المتصفح');
                else dirStatus.innerText = "الحالة: لم يتم التحميل";
                if (minBlob) await processFile(minBlob, 'ministry', 'ذاكرة المتصفح');
                else minStatus.innerText = "الحالة: لم يتم التحميل";
            } catch (error) {
                console.error("Startup Error:", error);
                dirStatus.innerText = "الحالة: خطأ في تحميل الذاكرة.";
                minStatus.innerText = "الحالة: خطأ في تحميل الذاكرة.";
            }
        };

        async function loadFileFromRepo(type) {
            const config = fileConfigs[type];
            const statusEl = document.getElementById(config.statusEl);
            statusEl.innerText = `الحالة: جاري التحميل...`;
            try {
                const response = await fetch(config.name);
                if (!response.ok) throw new Error(`لم يتم العثور على الملف "${config.name}"`);
                const blob = await response.blob();
                await processFile(blob, type, 'المستودع');
                saveFileToDb(type, blob);
            } catch (e) {
                statusEl.innerText = `الحالة: فشل التحميل. ${e.message}`;
            }
        }

        async function loadFileFromLocal(inputElement, type) {
            if (!inputElement.files.length) return;
            const file = inputElement.files[0];
            await processFile(file, type, 'الجهاز المحلي');
            saveFileToDb(type, file);
        }

        async function processFile(fileBlob, type, source) {
            const config = fileConfigs[type];
            const statusEl = document.getElementById(config.statusEl);
            try {
                const workbook = await readExcelBlob(fileBlob);
                await config.processor(workbook);
                statusEl.innerHTML = `✅ تم التحميل بنجاح من: <strong>${source}</strong>`;
                checkIfReady();
            } catch (e) {
                statusEl.innerText = `الحالة: فشل التحليل. ${e.message}`;
                console.error(e);
            }
        }

        const readExcelBlob = (blob) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = e => { try { resolve(XLSX.read(e.target.result, { type: 'array' })); } catch(err) { reject(err); }};
            reader.onerror = e => reject(new Error("فشل في قراءة الملف"));
            reader.readAsArrayBuffer(blob);
        });

        function processDirectorateData(workbook) {
            // This function's logic remains the same
        }
        function processMinistryData(workbook) {
            // This function's logic remains the same
        }

        function checkIfReady() {
            if (directorateData.length > 0 && ministryData.size > 0) {
                const step2 = document.getElementById('step2');
                step2.innerHTML = document.getElementById('search-template').innerHTML;
                step2.classList.remove('hidden');
                document.getElementById('step1').classList.add('hidden'); // Hide step 1 when ready
                document.getElementById('searchBtn').addEventListener('click', performSearch);
                document.getElementById('searchInput').addEventListener('keyup', (e) => { if (e.key === 'Enter') performSearch(); });
                document.getElementById('exportBtn').addEventListener('click', exportToCsv);
                document.getElementById('printBtn').addEventListener('click', () => window.print());
                document.getElementById('resetBtn').addEventListener('click', resetSearch);
                const datalist = document.getElementById('itemsDatalist');
                datalist.innerHTML = '';
                for (const [code, name] of uniqueItems.entries()) {
                    const option = document.createElement('option');
                    option.dataset.code = code;
                    option.value = name;
                    datalist.appendChild(option);
                }
            }
        }
        
        function resetSearch() {
            document.getElementById('step1').classList.remove('hidden');
            document.getElementById('step2').classList.add('hidden');
            const searchInput = document.getElementById('searchInput');
            if (searchInput) searchInput.value = '';
            lastSearchResults = [];
        }

        function performSearch() {
            // This function's logic remains the same
        }

        function exportToCsv() {
            // This function's logic remains the same
        }
    </script>
</body>
</html>
